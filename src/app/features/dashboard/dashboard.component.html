<div class="page-container">
  <app-navbar></app-navbar>

  <div class="main-content">
    <div class="page-wrapper">
      <!-- Header -->
      <div class="dashboard-header">
        <div>
          <h1 class="page-title">Dashboard</h1>
          <p class="page-subtitle">Vue d'ensemble de vos statistiques</p>
        </div>
        <div class="header-actions">
          <a routerLink="/surveys" class="btn-action btn-action-secondary">
            Gerer les sondages
          </a>
          <a routerLink="/surveys/create" class="btn-action btn-action-primary">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1rem; height: 1rem;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            Nouveau sondage
          </a>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button
          (click)="setView('survey')"
          class="tab"
          [class.active]="currentView() === 'survey'">
          Statistiques Sondage
        </button>
        <button
          (click)="setView('clustering')"
          class="tab"
          [class.active]="currentView() === 'clustering'">
          Questions les plus posees
        </button>
      </div>

      <!-- ==================== VUE SONDAGE ==================== -->
      @if (currentView() === 'survey') {
        <!-- Loading State -->
        @if (surveyLoading()) {
          <div class="loading-container">
            <div class="loading-spinner"></div>
          </div>
        }

        <!-- Error State -->
        @if (surveyError()) {
          <div class="page-card">
            <div class="error-box">
              <p class="error-box-text">{{ surveyError() }}</p>
            </div>
            <button (click)="loadSurveyStats()" class="btn-action btn-action-primary" style="margin-top: 1rem;">Reessayer</button>
          </div>
        }

        <!-- Survey Stats Content -->
        @if (!surveyLoading() && !surveyError() && surveyStats()) {
          <!-- Stats Cards -->
          <div class="stats-grid">
            <div class="stat-card stat-card-gradient stat-card-blue">
              <div class="stat-header">
                <h3 class="stat-title">Reponses totales</h3>
                <span class="badge badge-info" style="background: rgba(255,255,255,0.2); color: white;">Total</span>
              </div>
              <p class="stat-value">{{ surveyStats()?.totalResponses || 0 }}</p>
              <p class="stat-label">Reponses recues</p>
            </div>

            <div class="stat-card stat-card-gradient stat-card-purple">
              <div class="stat-header">
                <h3 class="stat-title">Questions</h3>
                <span class="badge badge-info" style="background: rgba(255,255,255,0.2); color: white;">Sondage actif</span>
              </div>
              <p class="stat-value">{{ surveyStats()?.questions?.length || 0 }}</p>
              <p class="stat-label">Questions configurees</p>
            </div>
          </div>

          <!-- Survey Details -->
          @if (surveyStats()?.survey) {
            <div class="page-card" style="margin-bottom: 1.5rem;">
              <div class="card-header">
                <h2 class="card-title">Sondage actif</h2>
                <span class="badge" [class.badge-success]="surveyStats()?.survey?.is_active" [class.badge-gray]="!surveyStats()?.survey?.is_active">
                  {{ surveyStats()?.survey?.is_active ? 'Actif' : 'Inactif' }}
                </span>
              </div>

              <div class="survey-info">
                <div class="survey-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
                  </svg>
                </div>
                <div>
                  <h3 class="survey-title">{{ surveyStats()?.survey?.title }}</h3>
                  <p class="survey-description">{{ surveyStats()?.survey?.description }}</p>
                </div>
              </div>

              <div class="divider"></div>

              <div class="survey-meta">
                <div class="meta-item">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                  </svg>
                  <span>{{ surveyStats()?.questions?.length || 0 }} question{{ (surveyStats()?.questions?.length || 0) > 1 ? 's' : '' }}</span>
                </div>
                <div class="meta-item">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                  </svg>
                  <span>{{ surveyStats()?.totalResponses || 0 }} reponse{{ (surveyStats()?.totalResponses || 0) > 1 ? 's' : '' }}</span>
                </div>
                <div class="meta-item">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                  </svg>
                  <span>Acces {{ surveyStats()?.survey?.is_active ? 'public' : 'ferme' }}</span>
                </div>
              </div>
            </div>
          } @else {
            <div class="page-card" style="margin-bottom: 1.5rem;">
              <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="empty-state-icon">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
                </svg>
                <h3 class="empty-state-title">Aucun sondage actif</h3>
                <p class="empty-state-text">Activez un sondage pour voir ses statistiques ici</p>
                <a routerLink="/surveys" class="btn-action btn-action-primary" style="margin-top: 1rem;">Gerer les sondages</a>
              </div>
            </div>
          }

          <!-- Questions List -->
          @if (surveyStats()?.questions && surveyStats()?.questions!.length > 0) {
            <div class="page-card" style="margin-bottom: 1.5rem;">
              <h2 class="card-title" style="margin-bottom: 1.5rem;">Questions du sondage</h2>
              <div class="questions-list">
                @for (question of surveyStats()?.questions; track question.id; let i = $index) {
                  <div class="question-item">
                    <div class="question-number">{{ i + 1 }}</div>
                    <div class="question-content">
                      <h3 class="question-text">
                        {{ question.question_text }}
                        @if (question.is_required) {
                          <span class="required-mark">*</span>
                        }
                      </h3>
                      <span class="badge badge-gray">
                        {{ question.question_type === 'multiple_choice' ? 'Choix multiple' :
                           question.question_type === 'text' ? 'Texte libre' : 'Notation' }}
                      </span>
                      @if (question.options && question.options.length > 0) {
                        <div class="question-options">
                          @for (option of question.options; track option) {
                            <div class="option-item">
                              <span class="option-bullet"></span>
                              <span>{{ option }}</span>
                            </div>
                          }
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Quick Actions -->
          <div class="quick-actions">
            <a routerLink="/surveys" class="page-card page-card-hover action-card">
              <div class="action-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
                </svg>
              </div>
              <div>
                <h3 class="action-title">Gerer les sondages</h3>
                <p class="action-text">Voir tous les sondages et en activer un</p>
              </div>
            </a>

            <a routerLink="/survey" class="page-card page-card-hover action-card">
              <div class="action-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </div>
              <div>
                <h3 class="action-title">Voir le sondage</h3>
                <p class="action-text">Apercu du formulaire public</p>
              </div>
            </a>
          </div>
        }
      }

      <!-- ==================== VUE CLUSTERING ==================== -->
      @if (currentView() === 'clustering') {
        <!-- Loading State -->
        @if (clusteringLoading()) {
          <div class="loading-container">
            <div class="loading-spinner"></div>
          </div>
        }

        <!-- Error State -->
        @if (clusteringError()) {
          <div class="page-card">
            <div class="error-box">
              <p class="error-box-text">{{ clusteringError() }}</p>
            </div>
            <button (click)="loadClusteringStats()" class="btn-action btn-action-primary" style="margin-top: 1rem;">Reessayer</button>
          </div>
        }

        <!-- Clustering Stats Content -->
        @if (!clusteringLoading() && !clusteringError()) {
          <!-- Global Stats Cards -->
          @if (clusteringStats()) {
            <div class="stats-grid-4">
              <div class="stat-card stat-card-gradient stat-card-blue">
                <p class="stat-label-small">Questions totales</p>
                <p class="stat-value-small">{{ clusteringStats()?.totalQuestions || 0 }}</p>
              </div>
              <div class="stat-card stat-card-gradient stat-card-purple">
                <p class="stat-label-small">Clusters</p>
                <p class="stat-value-small">{{ clusteringStats()?.totalClusters || 0 }}</p>
              </div>
              <div class="stat-card stat-card-gradient stat-card-green">
                <p class="stat-label-small">Questions aujourd'hui</p>
                <p class="stat-value-small">{{ clusteringStats()?.questionsToday || 0 }}</p>
              </div>
              <div class="stat-card stat-card-gradient stat-card-orange">
                <p class="stat-label-small">Similarite moyenne</p>
                <p class="stat-value-small">{{ (clusteringStats()?.overallAvgSimilarity || 0) * 100 | number:'1.0-0' }}%</p>
              </div>
            </div>
          }

          <!-- Top Clusters -->
          <div class="page-card">
            <div class="card-header">
              <h2 class="card-title">Questions les plus posees</h2>
              <span class="page-subtitle">Top 10</span>
            </div>

            @if (topClusters().length === 0) {
              <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="empty-state-icon">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                </svg>
                <h3 class="empty-state-title">Aucune question enregistree</h3>
                <p class="empty-state-text">Les questions posees par les utilisateurs apparaitront ici</p>
              </div>
            } @else {
              <div class="clusters-list">
                @for (cluster of topClusters(); track cluster.id; let i = $index) {
                  <div class="cluster-item">
                    <div class="cluster-rank" [class.rank-1]="i === 0" [class.rank-2]="i === 1" [class.rank-3]="i === 2">
                      #{{ i + 1 }}
                    </div>
                    <div class="cluster-content">
                      <p class="cluster-text">"{{ cluster.representativeText }}"</p>
                      <div class="cluster-meta">
                        <span class="meta-item">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                          </svg>
                          <strong>{{ cluster.questionCount }}</strong> fois posee
                        </span>
                        <span class="meta-item">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                          </svg>
                          {{ cluster.questionsToday }} aujourd'hui
                        </span>
                        <span class="meta-item">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          {{ formatDateShort(cluster.lastActivityAt) }}
                        </span>
                      </div>
                    </div>
                    <div class="cluster-count">
                      <span class="badge badge-info">{{ cluster.questionCount }}</span>
                    </div>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Info about clustering -->
          <div class="info-box" style="margin-top: 1.5rem;">
            <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.25rem; height: 1.25rem; flex-shrink: 0; color: #3b82f6;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
              </svg>
              <div>
                <p class="info-box-text" style="font-weight: 500; margin-bottom: 0.25rem;">Comment ca fonctionne ?</p>
                <p class="info-box-text">
                  Les questions similaires sont automatiquement regroupees grace a l'intelligence artificielle.
                  Cela permet d'identifier les sujets les plus frequents poses par vos utilisateurs.
                </p>
              </div>
            </div>
          </div>
        }
      }
    </div>
  </div>
</div>
