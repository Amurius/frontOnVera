<div class="fixed inset-0 bg-newspaper bg-cover bg-center -z-10"></div>
<div class="min-h-screen">
  <app-navbar></app-navbar>

  <div class="ml-[84px] min-h-screen p-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-h2 font-heading font-medium text-vera-dark">Résultats du sondage</h1>
        @if (survey()) {
          <p class="text-small text-gray-500 mt-1">{{ survey()?.title }}</p>
        }
      </div>
      <div class="flex items-center gap-3">
        <a routerLink="/surveys" class="px-4 py-2 rounded-[8px] border border-gray-200 text-small font-medium text-vera-dark hover:bg-gray-50 transition-colors">
          Retour à la liste
        </a>
        @if (!loading() && !error() && questionResults().length > 0) {
          <button (click)="exportResults()" class="flex items-center gap-2 px-4 py-2 rounded-[8px] bg-vera-dark text-small font-medium text-white hover:opacity-90 transition-opacity">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Export CSV
          </button>
        }
      </div>
    </div>

    <!-- Loading State -->
    @if (loading()) {
      <div class="flex items-center justify-center py-20">
        <div class="w-8 h-8 border-4 border-vera-dark border-t-transparent rounded-full animate-spin"></div>
      </div>
    }

    <!-- Error State -->
    @if (error()) {
      <div class="bg-white rounded-[16px] p-6" style="border: 1px solid #E5E7EB;">
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <p class="text-small text-red-700">{{ error() }}</p>
        </div>
        <a routerLink="/surveys" class="mt-4 inline-block px-4 py-2 rounded-[8px] bg-vera-dark text-white text-small font-medium hover:opacity-90 transition-opacity">
          Retour à la liste
        </a>
      </div>
    }

    <!-- Results Content -->
    @if (!loading() && !error()) {
      <div class="space-y-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-3 gap-6">
          <div class="bg-[#C07926] rounded-[16px] p-6 text-white">
            <p class="text-small opacity-80 mb-2">Réponses totales</p>
            <p class="text-h2 font-medium leading-none">{{ totalResponses() }}</p>
          </div>
          <div class="bg-[#403637] rounded-[16px] p-6 text-white">
            <p class="text-small opacity-80 mb-2">Questions</p>
            <p class="text-h2 font-medium leading-none">{{ questionResults().length }}</p>
          </div>
          <div class="bg-white rounded-[16px] p-6" style="border: 1px solid #E5E7EB;">
            <p class="text-small text-gray-500 mb-2">Date de création</p>
            <p class="text-large font-medium text-vera-dark">{{ formatDate(survey()?.created_at || '') }}</p>
          </div>
        </div>

        <!-- Survey Info -->
        @if (survey()) {
          <div class="bg-white rounded-[16px] p-6" style="border: 1px solid #E5E7EB;">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-large font-medium text-vera-dark">Informations du sondage</h2>
              <span class="px-3 py-1 rounded-full text-small font-medium"
                [class.bg-green-100]="survey()?.is_active"
                [class.text-green-700]="survey()?.is_active"
                [class.bg-gray-100]="!survey()?.is_active"
                [class.text-gray-600]="!survey()?.is_active">
                {{ survey()?.is_active ? 'Actif' : 'Inactif' }}
              </span>
            </div>
            <h3 class="text-large font-medium text-vera-dark mb-2">{{ survey()?.title }}</h3>
            <p class="text-small text-gray-500">{{ survey()?.description }}</p>
          </div>
        }

        <!-- Results by Question -->
        <div class="space-y-6">
          @if (questionResults().length === 0) {
            <div class="bg-white rounded-[16px] p-8 text-center" style="border: 1px solid #E5E7EB;">
              <div class="w-16 h-16 mx-auto mb-4 flex items-center justify-center rounded-full bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-400">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25Z" />
                </svg>
              </div>
              <h3 class="text-large font-medium text-vera-dark mb-2">Aucune réponse pour le moment</h3>
              <p class="text-small text-gray-500">Les résultats apparaîtront ici une fois que des utilisateurs auront répondu au sondage.</p>
            </div>
          } @else {
            @for (question of questionResults(); track question.questionId; let i = $index) {
              <div class="bg-white rounded-[16px] p-6" style="border: 1px solid #E5E7EB;">
                <!-- Question Header -->
                <div class="flex items-center gap-4 mb-4">
                  <span class="w-8 h-8 flex items-center justify-center rounded-full bg-vera-dark text-white text-small font-semibold flex-shrink-0">{{ i + 1 }}</span>
                  <div class="flex-1 flex items-center justify-between">
                    <h3 class="text-large font-medium text-vera-dark">{{ question.questionText }}</h3>
                    <span class="px-3 py-1 rounded-full text-small font-medium bg-gray-100 text-gray-600">{{ question.totalResponses }} réponses</span>
                  </div>
                </div>

                <!-- Chart -->
                <div class="h-[280px]">
                  <div echarts [options]="getQuestionChartOptions(question)" class="w-full h-full"></div>
                </div>

                <!-- Response Summary -->
                <div class="mt-6 pt-6 border-t border-gray-100">
                  <div class="grid grid-cols-2 gap-4 max-md:grid-cols-1">
                    @for (response of question.responses; track response.option; let j = $index) {
                      <div class="flex items-center justify-between p-3 rounded-[8px] bg-gray-50">
                        <div class="flex items-center gap-3">
                          <span class="w-3 h-3 rounded-full flex-shrink-0" [style.background-color]="getChartColor(j)"></span>
                          <span class="text-small text-vera-dark">{{ response.option }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="text-small font-medium text-vera-dark">{{ response.count }}</span>
                          <span class="text-small text-gray-500">({{ getResponsePercentage(response.count, question.totalResponses) }}%)</span>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              </div>
            }
          }
        </div>

        <!-- Back Button -->
        <div class="flex justify-center pt-4">
          <a routerLink="/surveys" class="flex items-center gap-2 px-6 py-3 rounded-[8px] border border-gray-200 text-small font-medium text-vera-dark hover:bg-gray-50 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
            </svg>
            Retour à la gestion des sondages
          </a>
        </div>
      </div>
    }
  </div>
</div>
